# 올바른 마이크로서비스 경계를 만드는 것

## 정보 은닉
모듈 경계 뒤 가능한 많은 세부 정보를 숨기려는 욕구.
모듈 간 연결을 최소화할수록 독립성이 커진다

### 장점
- 독립적으로 모듈을 개발할 수 있기에 병렬적으로 작업 수행 가능
- 각 모듈을 따로따로 살펴보고 이해할 수 있음
- 모듈이 서로 독립적이므로 다른 모듈을 변경하지 않고 기능 변경이 가능

## 응집력
서로 관련이 있는. 즉, 함께 바뀌고 함께 머무는 코드

## 결합
서비스 내부를 변경했을 때 소비자도 함께 변경해야한다면 강한 결합 상태라고 할 수 있다
느슨하게 결합되었을 때 서비스는 필수적인 정보를 제외하고는 서로에 대해 모른다
또한 서비스간 다양한 유형의 호출이 많다면 과도한 커뮤니케이션으로 강한 결합이 생길 수 있다

## 결합과 응집력의 연관성
`응집력`은 경계 내부에 있는 사물 사이의 관계
`결합`은 경계 너머에 있는 사물 간 관계

# 결합 유형

느슨한 결합 ----------------------------> 강한 결합<br/>
--------- 도메인 --> 통과 --> 공통 --> 내용 --------

## 도메인 결합
마이크로서비스가 서로 상호작용해야 하는 경우를 뜻한다
이렇게 한 서비스가 상호작용하는 서비스가 많아질수록 하나의 서비스가 너무 많은 일을 하는 문제가 생길 수 있다

## 통과 결합
주문 -> 창고 -> 배송 과정에서 창고는 품목만 필요하지만 `창고에서 배송으로 상호작용하므로 배송 목록 데이터를 같이 전달`하는 경우이다
만약 하위에서 전달하는 데이터의 구조 등이 변경되면 상위에서 더 큰 변경이 필요할 수 있다는게 통과 결합의 문제점이다
해결하는 방법은
1. 주문이 창고, 배송 모두에 데이터를 전달하도록 만드는 방식으로 도메인 결합이 늘어나고, 창고가 담당했던 복잡한 로직을 주문이 처리하도록 변경해야한다
2. 주문에서 창고로 배송 주소를 전달하고, 배송 목록은 창고에서 만드는 방식(주문 <-> 배송 간의 배송 목록 데이터 구조를 알 필요가 없다)
3. `창고에서 배송으로 상호작용하므로 배송 목록 데이터를 같이 전달`하는 것은 여전하지만 창고가 배송 목록의 구조를 전혀 알지 못하도록 하는 방식

## 공통 결합
여러 마이크로서비스가 공유 DB, 공유 메모리 공유 파일 시스템 등 공통 데이터 집합을 사용하는 경우 발생한다
만약 공통 데이터 집합의 데이터 구조를 변경하면, 연관된 마이크로서비스들이 모두 영향을 미친다는 점이다
대안으로는 공통 데이터 집합과 단독으로 상호작용하는 레포지터리 마이크로서비스를 만들고, DB업데이트 등의 작업이 필요할 때 레포지터리 마이크로서비스에게 요청하도록 하는 것이다.

공통 결합이 생길수록 공유 데이터 집합에 과부하가 생길 수 있고 race condition 문제가 생길 수 있다

## 내용 결합
상위 서비스가 하위 서비스 내부까지 도달해 내부 상태를 변경하는 상황
소유권의 경계선이 명확하지 않아 개발자가 시스템을 변경하기 더 어렵다(정보 은닉의 부재)
예를 들어 레포지터리 마이크로서비스가 존재하는 상황에서 이를 무시하고 DB와 직접 상호작용하는 경우이다

# DDD
마이크로서비스 경계를 찾는데 DDD를 사용한다
DDD의 중요 핵심 개념들은 아래와 같다
- 보편언어
- 애그리거트
- 경계 컨텍스트

## 보편 언어
사용자가 쓰는 용어를 코드에서 동일하게 사용하도록 노력하는 것.
실제 서비스가 돌아가는 방식을 표현하는 용어들을 코드에 녹여내는 것이다

## 애그리거트
시스템의 일부로 관리될 상태, 고유성, 수명주기를 갖는 것으로, 실제 도메인을 나타낸 상태 기계에서 상태같은 것을 뜻한다

## 경계 컨텍스트
데이터를 공유하는 범위 정도로 생각하면 될 것 같다.
같은 데이터를 공유하는 범위를 묶을 때 경계 컨텍스트를 사용한다
앞에서는 하나의 마이크로서비스의 응집력과 결합을 이야기했다면, 경계 컨텍스트는 도메인 단위로 응집력과 결합을 이야기한다
만약 하나의 데이터가 여러 범위에 묶일 때, 이는 `문맥에 따라 같은 데이터지만 다른 정보`라고 생각해야한다

## 마이크로서비스에서 DDD의 장점
1. 경계 컨텍스트가 정보 은닉에 명시적으로 사용된다
2. 공통적 보편 언어를 정의하는 데 중점을 두는 것은 마이크로서비스 엔드포인트 정의에 큰 도움이 된다
3. 경계 컨텍스트로 시스템이 분해되어있다면, 변경 사항들은 한 마이크로서비스 경계로 한정될 가능성이 높다
